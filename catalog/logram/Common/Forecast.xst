<?xml version='1.0' encoding='utf-8' standalone='yes'?>
<xst path='/$YS/TYPES/LoBlock/Common' m='{"attr":65}'>
  <i n='Forecast' s='{"cctor":{"LoBlock":"Common/Forecast"},"Children":{"history":{"default":{},"manifest":{"attr":69}},"In":{"ddr":-1,"manifest":{"attr":69},"rc":"X1"},"interval":{"default":900000,"manifest":{"attr":69}},"Out":{"default":0,"ddr":1,"manifest":{"attr":65},"rc":"X9"}},"default":"","hint":"Forecast","icon":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAACn0lEQVQ4T53ST2hcZRQF8HPue+Mk09G2iWkLzbz3vplRxIC48B9I0z+IggyCdSG1pZvSYkCoixaKiBs3LrTqRlwIupJCF6W7bkoX3bQoikIU1ExmktEYbdJa0iaTed93ZAqWjF3pXd3N/d3L5RD/o5xzTyFHcXZ+9jL/63wtSZ4leap4u3xg+s/plXuAh5OkmpvtXs/z851OZ3njgoecm/TSiYJ03JPbEcffDgCu4nYx0kkDLkmYDIGn+2f2kVqa7gX5JqLoKPL8IskFBZ69C1TTdD/EJ5pzrbfHx8eLpVJpxHfX3wf0i8QeiWe6Pn9lSEOjiP1Hoj4TkN0Baok7JihrzrXeqlcqNZldAXmdnicC9TgBt6m7+sb3i4u3JsYmyt3S7S8GAJe6Iwz8rjnf/LqeZS9IfBLUPKSbM+32uY1/2IM9cSdtn7kLPLJz52gvLkwDsJl2a1s1qTaM2hEob8Ay4viCev4dIBS63r9X79RvbgAc60kyIfI4xESxvWq5JkFsB4Ig+yM3/WzSuwaue+PH6Wz6zQDQD4UFPA/oUUU2ZT3thoUxyUwMvxm5BGCvxIgIF8fb7qsBoJam+yCriXh664MjU38tLb0YpFGSBUhzRi4EsSFoBJF9mjST5j8ApSrrFfeSIg1Deq7SdlPzWashYCuAIQOa8tGvon+N1P2e/CBrZZ0BoJplB8zzlqiXt4yNHrtx7VoD5AOUyl72k8kWGPlDkkqePH0PUEvc0QC0yHB4uFw+srqy0qCsDGCz4H+gCot3AGDYAx/+C6ixnmWnfOCMQQcV20mGsM9gQz6ELQb+GDyXLPb7JeZm+Py+dVteK+gTIXxp5DZWs+x1Ax4TGAFaA1CE+n0oAlgTrAdoGOBqP1AGUYCD7HcJV/8GU4Nn55h0b3AAAAAASUVORK5CYII=","manifest":{"attr":66,"type":"LoBlock/Common/Forecast"},"namePrefix":"A","src":"class Forecast{\r\n  constructor(){  // In, interval, history, Out \r\n    this.tm = null;\r\n    this.Calculate(\"interval\");\r\n    this.T1 = 0;\r\n    this.V1 = 0;\r\n    this.V2 = 0;\r\n  }\r\n  Calculate(pin){\r\n    if(this.tm==null){\r\n      this.SetState(\"Out\", this.GetState(\"In\"));\r\n    }\r\n    if(pin==\"interval\"){\r\n      if(this.tm != null){\r\n        clearInterval(this.tm); \r\n      }\r\n      let interval = this.GetState(\"interval\");\r\n      if(interval &gt; 1000){\r\n        this.tm = setInterval(this.Tick.bind(this), interval / 5);\r\n      }\r\n    } else if(pin==\"In\"){\r\n      this.Update();\r\n    }\r\n  }\r\n  Tick(){\r\n    this.Update();        \r\n  }\r\n  Update(){\r\n    let vi = this.GetState(\"In\");\r\n    if(typeof(vi)==\"number\" &amp;&amp; !isNaN(vi)){\r\n      let hi = this.GetState(\"history\");\r\n      let interval = this.GetState(\"interval\");\r\n      let now = new Date();\r\n\r\n      if(!Array.isArray(hi)){\r\n        hi = [];\r\n      }\r\n      if(hi.length==0 || now.getTime() - hi[0].t.getTime() &gt; interval/10 ){\r\n        hi.unshift({\"t\":now, \"v\":vi});\r\n        let alpha = (hi.length&gt;1 &amp;&amp; interval&gt;0)?((hi[0].t.getTime() - hi[1].t.getTime())/interval):0.1;\r\n        this.SetState(\"alpha\", alpha);\r\n        if(hi.length&gt;2){\r\n          hi.pop();\r\n        }\r\n        this.SetState(\"history\", hi.slice(0));  // hi(new) != hi(old)\r\n        if(this.T1==0){\r\n          this.V1 = hi[0].v;\r\n          this.T1 = hi[0].t;\r\n        } else {\r\n          this.V1 = this.V1*(1-alpha) + hi[0].v*alpha;\r\n          this.T1 = this.T1*(1-alpha) + hi[0].t*alpha;\r\n        }\r\n        if(hi.length&gt;1){\r\n          let d1 = (hi[0].v - hi[1].v)/(hi[0].t.getTime() - hi[1].t.getTime());\r\n          this.V2 = this.V2*(1-alpha) + d1*alpha;\r\n        }\r\n      }\r\n\r\n      let T = now.getTime() + interval - this.T1;\r\n\r\n      this.SetState(\"T\", T/1000);\r\n      this.SetState(\"T1\", new Date(this.T1));\r\n      this.SetState(\"V1\", this.V1);\r\n      this.SetState(\"V2\", this.V2*T);\r\n      this.SetState(\"Out\", this.V1 + this.V2 * T);\r\n    }\r\n  }\r\n}","willful":true}' m='{"attr":69,"type":"Ext/LBDescr"}'  ver='0.4.1805.22689' />
</xst>